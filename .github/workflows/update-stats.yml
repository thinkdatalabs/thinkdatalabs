name: ğŸš€ Think Data Labs - GitHub Activity & Repository Metrics Update

on:
  schedule:
    - cron: '0 */6 * * *'    # Update every 6 hours for real-time activity
    - cron: '0 2 * * 1'      # Weekly comprehensive update on Mondays at 2 AM
  workflow_dispatch:         # Allow manual trigger
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: false
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'activity-only'
          - 'repositories-only'
      force_rebuild:
        description: 'Force rebuild all badges'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
      - master
    paths:
      - 'README.md'
      - '.github/workflows/**'

env:
  GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  COMPANY_NAME: "Think Data Labs"
  GITHUB_USERNAME: "thinkdatalabs"
  BOT_NAME: "think-data-labs-bot"
  BOT_EMAIL: "dev@thinkdatalabs.com"
  TIMEZONE: "Asia/Kolkata"

jobs:
  # Environment setup and validation
  setup-environment:
    runs-on: ubuntu-latest
    name: ğŸ”§ Environment Setup & Validation
    outputs:
      should_update_activity: ${{ steps.scope.outputs.activity }}
      should_update_repositories: ${{ steps.scope.outputs.repositories }}
      timestamp: ${{ steps.time.outputs.timestamp }}
      date_formatted: ${{ steps.time.outputs.date_formatted }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Generate timestamps
        id: time
        run: |
          echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "date_formatted=$(date +'%B %d, %Y')" >> $GITHUB_OUTPUT

      - name: Determine update scope
        id: scope
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'full' }}"
          FORCE_REBUILD="${{ github.event.inputs.force_rebuild || 'false' }}"
          
          echo "ğŸ¯ Update Configuration:"
          echo "- Type: $UPDATE_TYPE"
          echo "- Force Rebuild: $FORCE_REBUILD"
          
          case $UPDATE_TYPE in
            "full")
              echo "activity=true" >> $GITHUB_OUTPUT
              echo "repositories=true" >> $GITHUB_OUTPUT
              ;;
            "activity-only")
              echo "activity=true" >> $GITHUB_OUTPUT
              echo "repositories=false" >> $GITHUB_OUTPUT
              ;;
            "repositories-only")
              echo "activity=false" >> $GITHUB_OUTPUT
              echo "repositories=true" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Validate environment and tokens
        run: |
          echo "ğŸ” Environment Validation:"
          
          if [ -z "${{ env.GITHUB_TOKEN }}" ]; then
            echo "âŒ PERSONAL_ACCESS_TOKEN is not configured"
            exit 1
          fi
          echo "âœ… GitHub Token: Configured"
          
          curl -s -H "Authorization: token ${{ env.GITHUB_TOKEN }}" \
               "https://api.github.com/user" > /dev/null
          
          if [ $? -eq 0 ]; then
            echo "âœ… GitHub API Access: Verified"
          else
            echo "âŒ GitHub API Access: Failed"
            exit 1
          fi
          
          echo "ğŸ‰ Environment validation completed successfully"

  # Update repository statistics and metadata
  update-repository-data:
    runs-on: ubuntu-latest
    name: ğŸ“Š Update Repository Statistics
    needs: setup-environment
    if: needs.setup-environment.outputs.should_update_repositories == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install required dependencies
        run: |
          npm install -g @octokit/rest chalk axios
          
      - name: Update repository statistics table
        run: |
          echo "ğŸ“Š Updating Think Data Labs repository statistics..."
          
          cat > update_repositories.js << 'EOF'
          const { Octokit } = require('@octokit/rest');
          const fs = require('fs');
          const chalk = require('chalk');
          
          const octokit = new Octokit({
            auth: process.env.GITHUB_TOKEN
          });
          
          async function updateRepositoryData() {
            try {
              console.log(chalk.blue('ğŸ” Fetching Think Data Labs repositories...'));
              
              const { data: repos } = await octokit.rest.repos.listForOrg({
                org: 'thinkdatalabs',
                type: 'public',
                sort: 'updated',
                per_page: 100
              });
              
              console.log(chalk.green(`ğŸ“¦ Found ${repos.length} repositories`));
              
              // Repository list from README.md
              const featuredRepositories = [
                'python-data-analytics',
                'ml-model-deployment',
                'react-component-library',
                'nextjs-applications'
              ];
              
              let repositoryTableRows = '';
              let foundRepos = 0;
              
              for (const repoName of featuredRepositories) {
                const repo = repos.find(r => r.name === repoName);
                if (repo) {
                  foundRepos++;
                  const language = repo.language || 'Multiple';
                  const languageBadge = getLanguageBadge(language);
                  const status = repo.archived ? 'Archived' : 'Active';
                  const statusColor = status === 'Active' ? 'brightgreen' : 'red';
                  const statusBadge = `![${status}](https://img.shields.io/badge/Status-${status}-${statusColor})`;
                  
                  repositoryTableRows += `| ${repoName} | ${statusBadge} | ${languageBadge} | ![Stars](https://img.shields.io/github/stars/thinkdatalabs/${repoName}) | ![Forks](https://img.shields.io/github/forks/thinkdatalabs/${repoName}) | ![Issues](https://img.shields.io/github/issues/thinkdatalabs/${repoName}) | ![Last Commit](https://img.shields.io/github/last-commit/thinkdatalabs/${repoName}) |\n`;
                } else {
                  repositoryTableRows += `| ${repoName} | ![Planned](https://img.shields.io/badge/Status-Planned-yellow) | ![TBD](https://img.shields.io/badge/Language-TBD-lightgrey) | - | - | - | - |\n`;
                }
              }
              
              console.log(chalk.blue(`ğŸ“‹ Generated table for ${foundRepos} active repositories`));
              
              let readme = fs.readFileSync('README.md', 'utf8');
              
              const tableHeader = '| Repository | Status | Language | Stars | Forks | Issues | Last Commit |';
              const tableSeparator = '|------------|--------|----------|--------|-------|--------|-------------|';
              const fullTable = tableHeader + '\n' + tableSeparator + '\n' + repositoryTableRows;
              
              const tableRegex = /\| Repository \| Status \| Language[\s\S]*?(?=\n\n|\n---|\n##|\n###|$)/;
              if (tableRegex.test(readme)) {
                readme = readme.replace(tableRegex, fullTable);
                console.log(chalk.green('âœ… Repository status table updated'));
              } else {
                console.log(chalk.yellow('âš ï¸ Repository table section not found'));
              }
              
              fs.writeFileSync('README.md', readme);
              console.log(chalk.green('ğŸ‰ Repository data updated successfully!'));
              
            } catch (error) {
              console.error(chalk.red('âŒ Error updating repository data:'), error.message);
              process.exit(1);
            }
          }
          
          function getLanguageBadge(language) {
            const languageBadges = {
              'Python': '![Python](https://img.shields.io/badge/Python-3776AB?style=flat&logo=python&logoColor=white)',
              'JavaScript': '![JavaScript](https://img.shields.io/badge/JavaScript-F7DF1E?style=flat&logo=javascript&logoColor=black)',
              'TypeScript': '![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=flat&logo=typescript&logoColor=white)',
              'React': '![React](https://img.shields.io/badge/React-20232A?style=flat&logo=react&logoColor=61DAFB)',
              'Next.js': '![Next.js](https://img.shields.io/badge/Next.js-000000?style=flat&logo=next.js&logoColor=white)',
              'Multiple': '![Multiple](https://img.shields.io/badge/Multiple-Languages-rainbow?style=flat)'
            };
            
            return languageBadges[language] || `![${language}](https://img.shields.io/badge/${encodeURIComponent(language)}-gray?style=flat)`;
          }
          
          updateRepositoryData();
          EOF
          
          node update_repositories.js

      - name: Commit repository updates
        run: |
          git config --global user.name "${{ env.BOT_NAME }}"
          git config --global user.email "${{ env.BOT_EMAIL }}"
          
          if git diff --quiet; then
            echo "ğŸ“ No repository changes to commit"
          else
            git add README.md
            git commit -m "ğŸ“Š Update repository statistics

            - Updated repository status table
            - Refreshed project metadata
            - Synchronized badge information
            
            ğŸ¤– Auto-generated by Think Data Labs Bot"
            echo "âœ… Repository updates committed"
          fi

  # Update GitHub activity and recent contributions
  update-github-activity:
    runs-on: ubuntu-latest
    name: ğŸ”„ Update GitHub Activity Feed
    needs: setup-environment
    if: needs.setup-environment.outputs.should_update_activity == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Update recent GitHub activity
        uses: jamesgeorge007/github-activity-readme@master
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
        with:
          COMMIT_MSG: 'ğŸ”„ Update recent GitHub activity feed
            
            - Refreshed real-time activity section
            - Updated contribution timeline
            - Synchronized activity badges
            
            ğŸ¤– Auto-generated by Think Data Labs Bot'
          MAX_LINES: 12
          COMMIT_NAME: ${{ env.BOT_NAME }}
          COMMIT_EMAIL: ${{ env.BOT_EMAIL }}

  # Validate README structure and badges
  validate-readme:
    runs-on: ubuntu-latest
    name: ğŸ›¡ï¸ Validate README & Badges
    needs: setup-environment
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Validate README.md structure
        run: |
          echo "ğŸ” Validating Think Data Labs README.md structure..."
          
          REQUIRED_SECTIONS=(
            "GitHub Activity"
            "Repository Status Dashboard"
          )
          
          MISSING_SECTIONS=()
          
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if grep -q "## .*$section" README.md || grep -q "# .*$section" README.md; then
              echo "âœ… Section found: $section"
            else
              echo "âš ï¸ Section missing or incorrectly formatted: $section"
              MISSING_SECTIONS+=("$section")
            fi
          done
          
          if [ ${#MISSING_SECTIONS[@]} -gt 0 ]; then
            echo ""
            echo "ğŸ“‹ Missing sections summary:"
            printf ' - %s\n' "${MISSING_SECTIONS[@]}"
            exit 1
          else
            echo "ğŸ‰ All required sections are present!"
          fi

      - name: Validate badges
        run: |
          echo "ğŸ·ï¸ Validating GitHub badges..."
          
          BADGE_URLS=(
            "https://github-readme-stats.vercel.app/api?username=thinkdatalabs"
            "https://github-readme-streak-stats.herokuapp.com/?user=thinkdatalabs"
            "https://github-readme-stats.vercel.app/api/top-langs/?username=thinkdatalabs"
            "https://github-readme-activity-graph.vercel.app/graph?username=thinkdatalabs"
            "https://github-profile-trophy.vercel.app/?username=thinkdatalabs"
            "https://img.shields.io/github/stars/thinkdatalabs/python-data-analytics"
            "https://img.shields.io/github/forks/thinkdatalabs/react-component-library"
            "https://img.shields.io/github/stars/thinkdatalabs/ml-model-deployment"
            "https://img.shields.io/github/stars/thinkdatalabs/nextjs-applications"
          )
          
          for badge_url in "${BADGE_URLS[@]}"; do
            echo "Testing: $badge_url"
            if curl -s --head --max-time 10 "$badge_url" | head -n 1 | grep -q "200\|302"; then
              echo "âœ… Badge accessible: $badge_url"
            else
              echo "âš ï¸ Badge may have issues: $badge_url"
            fi
          done

  # Finalize updates and commit
  finalize-profile-update:
    runs-on: ubuntu-latest
    name: ğŸš€ Finalize Profile Updates
    needs: [
      setup-environment,
      update-repository-data,
      update-github-activity
    ]
    if: always() && !cancelled()
    
    steps:
      - name: Checkout repository with latest changes
        uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git for Think Data Labs Bot
        run: |
          git config --global user.name "${{ env.BOT_NAME }}"
          git config --global user.email "${{ env.BOT_EMAIL }}"

      - name: Pull and merge any remote changes
        run: |
          git pull origin main --rebase --autostash

      - name: Add profile update timestamp
        run: |
          echo "â° Adding Think Data Labs profile update timestamp..."
          
          TIMESTAMP="${{ needs.setup-environment.outputs.timestamp }}"
          DATE_FORMATTED="${{ needs.setup-environment.outputs.date_formatted }}"
          
          if grep -q "Last Updated:" README.md; then
            sed -i "s/Last Updated:.*/Last Updated: $DATE_FORMATTED/" README.md
            echo "âœ… Updated existing timestamp"
          else
            echo -e "\n---\n\n> **ğŸ”„ Last Updated:** $DATE_FORMATTED | **ğŸ¤– Automated by:** Think Data Labs Bot" >> README.md
            echo "âœ… Added new timestamp section"
          fi

      - name: Generate update summary
        run: |
          echo "ğŸ“Š Think Data Labs Profile Update Summary" > UPDATE_SUMMARY.md
          echo "============================================" >> UPDATE_SUMMARY.md
          echo "" >> UPDATE_SUMMARY.md
          echo "ğŸ•’ **Update Time:** ${{ needs.setup-environment.outputs.timestamp }}" >> UPDATE_SUMMARY.md
          echo "ğŸ¢ **Organization:** ${{ env.COMPANY_NAME }}" >> UPDATE_SUMMARY.md
          echo "" >> UPDATE_SUMMARY.md
          echo "### ğŸ“‹ Component Update Status:" >> UPDATE_SUMMARY.md
          echo "- **Environment Setup:** ${{ needs.setup-environment.result }}" >> UPDATE_SUMMARY.md
          echo "- **Repository Data:** ${{ needs.update-repository-data.result }}" >> UPDATE_SUMMARY.md
          echo "- **GitHub Activity:** ${{ needs.update-github-activity.result }}" >> UPDATE_SUMMARY.md
          echo "" >> UPDATE_SUMMARY.md
          
          if [[ "${{ needs.update-repository-data.result }}" == "success" ]] && \
             [[ "${{ needs.update-github-activity.result }}" == "success" ]]; then
            echo "ğŸ‰ **Overall Status:** SUCCESS" >> UPDATE_SUMMARY.md
            echo "âœ… Think Data Labs GitHub profile successfully updated!" >> UPDATE_SUMMARY.md
          else
            echo "âš ï¸ **Overall Status:** PARTIAL SUCCESS" >> UPDATE_SUMMARY.md
            echo "Some components may require manual review." >> UPDATE_SUMMARY.md
          fi
          
          echo "" >> UPDATE_SUMMARY.md
          echo "ğŸ”— **Profile URL:** https://github.com/thinkdatalabs" >> UPDATE_SUMMARY.md

      - name: Commit all finalized changes
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes detected for final commit"
          else
            echo "ğŸ“ Committing comprehensive profile updates..."
            
            COMMIT_MESSAGE="ğŸš€ Think Data Labs: Profile Update (${{ needs.setup-environment.outputs.date_formatted }})

            ğŸ“Š **Updated Components:**
            $([ "${{ needs.setup-environment.outputs.should_update_repositories }}" == "true" ] && echo "âœ… Repository statistics table")
            $([ "${{ needs.setup-environment.outputs.should_update_activity }}" == "true" ] && echo "âœ… GitHub activity badges and recent contributions")
            
            ğŸ¤– Auto-generated by Think Data Labs Bot"
            
            git commit -m "$COMMIT_MESSAGE"
            git push
            echo "âœ… Final changes pushed successfully"
          fi
